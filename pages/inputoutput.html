<!DOCTYPE html>
<script src="../js/privilege.js"></script>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../css/main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="../js/main.js"></script>
    <title>Ввод\вывод</title>
</head>
<body>
<div class="wrapper">
    <div class="header">
        Ввод\вывод
    </div>
    <form method="post" id="post_form">
        <div class="input_block">
            <label for="source">Источник</label>
            <select id="source" name="source" required onchange="fillOutputSelect(this.value)"></select>
        </div>
        <div class="input_block">
            <label for="destination">Назначение</label>
            <select id="destination" name="destination" required></select>
        </div>
        <div class="input_block middle">
            <label for="transaction">Сумма</label>
            <input type="number" name="transaction" id="transaction" min="0" placeholder="0" required>
        </div>
        <div class="input_block middle">
            <label for="commiss">Комиссия</label>
            <input type="number" name="commiss" id="commiss" step="0.01" min="0" value="0" required>
        </div>
        <div class="centered">
            <button class="button submit_button" type="submit">Отправить</button>
        </div>
    </form>
    <div>
        <a href="menu.html">
            <button class="button exit_button">В меню</button>
        </a>
    </div>
</div>
</body>
</html>
<script>
    var currencies, userReserves =[], sourceList = [], agents = [], selectedCurrency;
    $(document).ready(function () {
        getCurrencyList(function (data) {
            currencies = data;
        });
        getReserveList(function (data) {
            console.log(data);
            $.each(data, function (key, value) {
                if (value.responsible === username) {
                    userReserves.push(value);
                    sourceList.push(value.title);
                }
            });
            getAntiagentList(function (data1) {
                console.log(data1);
                $.each(data1, function (key1, value1) {
                    agents.push(value1);
                    sourceList.push(value1.agentname);
                });
                console.log(sourceList);
                fillSelectFromArray(document.getElementById('source'), sourceList);
            });
        });

        $("#post_form").on('submit', function (e) {
            e.preventDefault();
            $.ajax({
                url: apiServer + '/',
                type: 'post',
                crossDomain: true,
                data: $("#post_form").serialize(),
                success: function () {
                    $("#post_form").reset();
                    alert("ok!");
                }
            });
        });
    });

    function fillOutputSelect(inputValue) {
        var found = false;
        //checking if an input is a reserve
        for (var i = 0; i < userReserves.length; i++) {
            if (userReserves[i].title === inputValue) {
                selectedCurrency = userReserves[i].currency;
                var result1 = [];
                $.each(agents, function (key, value) {
                    result1.push(value.agentname);
                });
                $.each(userReserves, function (key, value) {
                    if ((value.title !== inputValue) && (value.currency === selectedCurrency)) {
                        result1.push(value.title);
                    }
                });
                fillSelectFromArray(document.getElementById('destination'), result1);
                found = true;
                break;
            }
        }
        //checking if an input is an agent
        if (!found) {
            for (var j = 0; j < agents.length; j++) {
                if (agents[j].agentname === inputValue) {
                    var result = [];
                    $.each(userReserves, function (key, value) {
                       result.push(value.title);
                    });
                    fillSelectFromArray(document.getElementById('destination'), result);
                    break;
                }
            }
        }
    }
</script>
