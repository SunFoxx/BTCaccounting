<!DOCTYPE html>
<script src="../js/privilege.js"></script>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../css/main.css">
    <script src="../js/vendor/jquery-3.2.1.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/vendor/sweetalert.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>Ввод\вывод</title>
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
</head>
<body>
<div class="wrapper">
    <div class="header">
        Ввод\вывод
    </div>
    <form method="post" id="post_form">
        <div class="input_block">
            <label for="source">Источник</label>
            <select id="source" name="source" required onchange="fillOutputSelect(this.value)">
                <option disabled selected value="" hidden>Загрузка...</option>
            </select>
        </div>
        <div class="input_block">
            <label for="destination">Назначение</label>
            <select id="destination" name="destination" required onchange="checkOutput(this.value)">
                <option disabled selected value="" hidden>Выберите источник</option>
            </select>
        </div>
        <div class="input_block middle">
            <label for="description">Описание</label>
            <input type="text" name="description" id="description" minlength="2" placeholder="Текст описания" required>
        </div>
        <div class="input_block middle">
            <label for="transaction">Сумма</label>
            <input type="number" name="transaction" id="transaction" min="0" placeholder="0" required>
        </div>
        <div class="input_block middle">
            <label for="commiss">Комиссия</label>
            <input type="number" name="commiss" id="commiss" step="0.01" min="0" value="0" required>
        </div>
        <div class="input_block middle">
            <label for="percent">Процентная ставка (сутки)</label>
            <input type="number" name="percent" id="percent" step="0.01" min="0" max="100" value="0" required>
        </div>
        <div class="centered">
            <button class="button submit_button" type="submit">Отправить</button>
        </div>
    </form>
    <div>
        <a href="menu.html">
            <button class="button exit_button">В меню</button>
        </a>
        <a href="inputoutput_history.html">
            <button class="button exit_button">История операций</button>
        </a>
    </div>
</div>
</body>
</html>
<script>
    var currencies, userReserves = [], sourceList = [], agents = [], selectedCurrency, fulfilled = false,
        sourceType = "", destType = "";
    $(document).ready(function () {
        getCurrencyList(function (data) {
            currencies = data;
        });
        getReserveList(function (data) {
            $.each(data, function (key, value) {
                if (value.responsible === username) {
                    userReserves.push(value);
                    sourceList.push(value.title);
                }
            });
            getAntiagentList(function (data1) {
                $.each(data1, function (key1, value1) {
                    agents.push(value1);
                    if (value1.internal === false) {
                        sourceList.push(value1.agentname);
                    }
                });
                fillSelectFromArray(document.getElementById('source'), sourceList);
            });
        });

        $("#post_form").on('submit', function (e) {
            e.preventDefault();
            $.ajax({
                url: apiServer + '/translate',
                type: 'post',
                crossDomain: true,
                headers: {'authorization': localStorage.getItem('token')},
                data: $("#post_form").serialize() + "&fulfilled=" + fulfilled,
                success: function () {
                    document.getElementById('post_form').reset();
                    swal("Успех", "Операция перевода была добавлена", "success");
                },
                error: function () {
                    swal("Упс", "Что-то пошло не так", "error");
                }
            });
        });
    });

    function fillOutputSelect(inputValue) {
        var found = false;
        //checking if an input is a reserve
        for (var i = 0; i < userReserves.length; i++) {
            if (userReserves[i].title === inputValue) {
                selectedCurrency = userReserves[i].currency;
                var result1 = [];
                $.each(agents, function (key, value) {
                    result1.push(value.agentname);
                });
                $.each(userReserves, function (key, value) {
                    if ((value.title !== inputValue) && (value.currency === selectedCurrency)) {
                        result1.push(value.title);
                    }
                });
                fillSelectFromArray(document.getElementById('destination'), result1);
                found = true;
                sourceType = 'reserve';
                break;
            }
        }
        //checking if an input is an agent
        if (!found) {
            for (var j = 0; j < agents.length; j++) {
                if (agents[j].agentname === inputValue) {
                    var result = [];
                    $.each(userReserves, function (key, value) {
                        result.push(value.title);
                    });
                    fillSelectFromArray(document.getElementById('destination'), result);
                    sourceType = 'agent';
                    break;
                }
            }
        }
    }

    function checkOutput(outputValue) {
        var found = false;
        //checking if an output is a reserve
        for (var i = 0; i < userReserves.length; i++) {
            if (userReserves[i].title === outputValue) {
                found = true;
                destType = 'reserve';
                break;
            }
        }
        //checking if an input is an agent
        if (!found) {
            for (var j = 0; j < agents.length; j++) {
                if (agents[j].agentname === outputValue && agents[j].internal === false) {
                    destType = 'agent';
                    break;
                }
            }
        }
        if ((sourceType === 'reserve' || sourceType === 'agent') && destType === 'reserve') {
            fulfilled = true;
        }
    }
</script>
