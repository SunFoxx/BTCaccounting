<!doctype html>
<script src="../js/privilege.js"></script>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../css/vendor/bootstrap.min.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>Кредиты</title>
    <script src="../js/vendor/jquery-3.2.1.min.js"></script>
    <script src="../js/main.js"></script>
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
</head>
<body>
<script>
    $(function(){
        $("#sidebar").load("templates/sidebar.html");
    });
</script>
<div id="sidebar"></div>
<div class="wrapper col-sm-7">
    <div class="header">Кредиты</div>
    <div id="notification" class="centered"></div>
    <div class="centered">
        <div id="credit_header" class="hidden">Вам должны</div>
        <table id="credit_table" class="handbook_table preload">
        </table>
        <div id="debit_header" class="hidden">Вы должны</div>
        <table id="debit_table" class="handbook_table preload">
        </table>
    </div>
    <div>
        <a href="menu.html">
            <button class="button exit_button">В меню</button>
        </a>
    </div>
</div>
</body>
</html>
<script>
    var credits = [], debets = [];
    $(document).ready(function () {
        getCredits(function (data) {
            console.log(data);
            $.each(data.credit, function (key, value) {
                credits.push(value);
            });
            $.each(data.debet, function (key, value) {
                debets.push(value);
            });
            buildCreditTable();
            buildDebtTable();
            if (credits.length === 0 && debets.length === 0) {
                $("#notification").html("Нет активных кредитов");
            }
        })
    });

    function buildCreditTable() {
        if (credits.length !== 0) {
            $("#credit_table").html('<tr>\n' +
                '<th>Заемщик</th>' +
                '<th>Сумма долга</th>' +
                '</tr>');
            var operational_data = "", creditList = {}, currentUser = "", creditSum = 0;
            credits.sort(function (a1, a2) {
                return a1.debet.localeCompare(a2.debet);
            });
            $.each(credits, function (key, value) {
                if (value.debet === currentUser && currentUser !== "") {
                    creditSum += value.debts;
                } else {
                    creditSum = value.debts;
                }
                currentUser = value.debet;
                creditList[currentUser] = creditSum;
            });
            $.each(creditList, function (key, value) {
                operational_data += '<tr>';
                operational_data += '<td>' + key + '</td>';
                operational_data += '<td>' + value + '</td>';
                operational_data += '</tr>';
            });
            $("#credit_table").append(operational_data);
            $("#credit_header").show(100);
            $("#credit_table.preload").removeClass('preload');
        } else {
            $("#credit_header").hide();
        }
    }

    function buildDebtTable() {
        if (debets.length !== 0) {
            $("#debit_table").html('<tr>\n' +
                '<th>Кредитор</th>' +
                '<th>Сумма долга</th>' +
                '</tr>');
            var operational_data = "", debitList = {}, currentUser = "", debitSum = 0;
            $.each(debets, function (key, value) {
                if (value.credit === currentUser && currentUser !== "") {
                    debitSum += value.debts;
                } else {
                    debitSum = value.debts;
                }
                currentUser = value.credit;
                debitList[currentUser] = debitSum;
            });
            $.each(debitList, function (key, value) {
                operational_data += '<tr>';
                operational_data += '<td>' + key + '</td>';
                operational_data += '<td>' + value + '</td>';
                operational_data += '</tr>';
            });
            $("#debit_table").append(operational_data);
            $("#debit_header").show(100);
            $("#debit_table.preload").removeClass('preload');
        } else {
            $("#debit_header").hide();
        }
    }
</script>
