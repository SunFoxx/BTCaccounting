<!DOCTYPE html>
<script src="../js/privilege.js"></script>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../css/vendor/bootstrap.min.css">
    <link rel="stylesheet" href="../css/main.css">
    <title>Покупка</title>
    <script src="../js/vendor/jquery-3.2.1.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/vendor/sweetalert.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
</head>
<body>
<script>
    $(function () {
        $("#sidebar").load("templates/sidebar.html");
        $("#header").load("templates/header.html");
    });
</script>
<div id="sidebar"></div>
<div id="header" class="col-md-7"></div>
<div class="wrapper col-sm-7">
    <div class="header">
        Покупка
    </div>
    <form method="post" id="post_form">
        <div class="input_block">
            <label for="paym" class="col-md-4">Резерв для оплаты</label>
            <select name="paym" id="paym" required class="col-md-4">
                <option disabled selected value="" hidden>Загрузка...</option>
            </select>
        </div>
        <div class="input_block">
            <label for="paymCrypto" class="col-md-4">Резерв зачисления</label>
            <select name="paymCrypto" id="paymCrypto" required class="col-md-4">
                <option disabled selected value="" hidden>Загрузка...</option>
            </select>
        </div>
        <div class="input_block">
            <label for="course" class="col-md-4">Курс сделки</label>
            <input type="number" name="course" required id="course" step="0.01" min="0" onkeyup="reCount()"
                   placeholder="0" class="col-md-4">
        </div>
        <div class="input_block">
            <label for="btc" class="col-md-4">Поступило</label>
            <input type="number" name="btc" required id="btc" step="0.00000001" min="0" onkeyup="reCount()"
                   placeholder="0.00000000" class="col-md-4">
        </div>
        <div class="input_block">
            <label for="commiss" class="col-md-4">Комиссия</label>
            <input type="number" name="commiss" id="commiss" step="0.01" min="0" value="0" onkeyup="reCount()" required
                   class="col-md-4">
        </div>
        <div class="input_block">
            <label for="bot_commiss">Комиссия бота</label>
            <input type="number" name="bot_commiss" id="bot_commiss" readonly step="0.01" min="0" value="0">
        </div>
        <div class="input_block middle">
            <label for="rub" class="col-md-4">Расход Р</label>
            <input type="number" name="rub" required id="rub" step="0.01" min="0" readonly class="col-md-4">
        </div>
        <div class="info_block">
            Текущий ср. курс: <span id="avg_course"></span><span id="avg_prognosis"></span><span id="deal_finrez"
                                                                                                 class="red"></span>
        </div>
        <div class="centered">
            <button class="button submit_button" type="submit" disabled id="submit_button">Отправить</button>
        </div>
    </form>
    <div>
        <a href="menu.html">
            <button class="button exit_button">В меню</button>
        </a>
        <a href="buy_history.html">
            <button class="button exit_button">История операций</button>
        </a>
    </div>
</div>
</body>
</html>
<script>
    var avgCourse, delayTimer, spentTotal, boughtTotal, xtraData;

    $(document).ready(function () {
        var r1 = getFullPaymentData(function (data) {
            document.getElementById('avg_course').innerHTML = data.avg;
            avgCourse = parseFloat(data.avg);
            spentTotal = parseFloat(data.rub);
            boughtTotal = parseFloat(data.btc);
        });
        var currencies;
        var r2 = getCurrencyList(function (data) {
            currencies = data;
        });
        var rubAccounts = [], btcAccounts = [], reservesBuy = [];
        var r3 = getReserveList(function (data) {
            reservesBuy = data;
        });
        $.when(r1, r2, r3).done(function () {
            $.each(reservesBuy, function (key, value) {
                if (value.responsible === username) {
                    var currency = value.currency;
                    $.each(currencies, function (key1, value1) {
                        if (currency === value1.currency) {
                            if (value1.isCrypto === true) {
                                btcAccounts.push(value.title);
                            } else {
                                rubAccounts.push(value.title);
                            }
                        }
                    })
                }
            });
            fillSelectFromArray(document.getElementById('paym'), rubAccounts);
            fillSelectFromArray(document.getElementById('paymCrypto'), btcAccounts);
        });
    });


    $("#post_form").on('submit', function (e) {
        e.preventDefault();
        $.ajax({
            url: apiServer + '/pay',
            headers: {
                'authorization': localStorage.getItem('token')
            },
            type: 'post',
            crossDomain: true,
            data: $("#post_form").serialize() + xtraData,
            success: function () {
                document.getElementById('post_form').reset();
                getFullPaymentData(function (data) {
                    document.getElementById('avg_course').innerHTML = data.avg;
                    avgCourse = parseFloat(data.avg);
                    spentTotal = parseFloat(data.rub);
                    boughtTotal = parseFloat(data.btc);
                });
                document.getElementById('avg_prognosis').innerHTML = "";
                document.getElementById('deal_finrez').innerHTML = '';
                $("#submit_button").prop("disabled", true);
                swal("Успех", "Запись была добавлена", "success");
            },
            error: function (err) {
                swal("Упс", "Что-то пошло не так", "error");
            }
        });
    });

    function reCount() {
        clearTimeout(delayTimer);
        delayTimer = setTimeout(function () {
            var btcValue = parseFloat($("#btc").val()),
                courseValue = parseFloat($("#course").val()),
                comissValue = parseFloat($("#commiss").val()),
                botcomissValue;
            if (isNaN(btcValue)) {
                btcValue = 0;
            }
            if (isNaN(courseValue)) {
                courseValue = 0;
            }
            if (isNaN(comissValue)) {
                comissValue = 0;
            }
            botcomissValue = btcValue * botComission;
            $("#bot_commiss").val(botcomissValue.toFixed(8));
            var rubResult = (courseValue * btcValue);
            $("#rub").val(rubResult.toFixed(2));

            var prognosisLine = document.getElementById('avg_prognosis');
            //prognosis field setter
            getAvgPrognose(rubResult, btcValue, boughtTotal, function (data) {
                var percentage = ((data / (avgCourse / 100)) - 100);
                var percentage_string = "";
                if (percentage > 0) {
                    if (!isFinite(percentage)) {
                        percentage = 0;
                    }
                    percentage_string = ("+" + percentage.toFixed(2));
                    prognosisLine.setAttribute('class', 'red');
                } else {
                    percentage_string = (percentage.toFixed(2));
                    prognosisLine.setAttribute('class', 'green');
                }
                var newAvrg = data;
                if (isNaN(newAvrg) || newAvrg.isUndefined) {
                    newAvrg = 0;
                    percentage_string = 0;
                }
                prognosisLine.innerHTML = '; Новый ср. курс: ' + newAvrg.toFixed(2) + ' (' + percentage_string + '%)';
                var finrez = getDealFinrez(0, newAvrg, 0, botcomissValue, comissValue);
                console.log('comiss ' + comissValue);
                console.log('comiss ' + finrez);
                document.getElementById('deal_finrez').innerHTML = '; Финрез сделки: ' + finrez;
                xtraData = "&average_course=" + newAvrg + "&cur_fin_res=" + finrez;
                $("#submit_button").prop("disabled", false);
            });
        }, 1000);
    }

    function getAvgPrognose(spent, bought, totalB, callback) {
        var result = ((totalB * avgCourse) + spent) / (totalB + bought);
        callback(result);
    }
</script>
