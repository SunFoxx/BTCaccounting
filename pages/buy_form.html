<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../css/main.css">
    <title>Покупка</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="../js/main.js"></script>
</head>
<body>
<div class="wrapper">
    <div class="header">
        Покупка
    </div>
    <form method="post" id="post_form">
        <div class="input_block">
            <label for="paym">Резерв для оплаты</label>
            <select name="paym" id="paym"></select>
        </div>
        <div class="input_block">
            <label for="bitwallet">Резерв зачисления</label>
            <select name="bitwallet" id="bitwallet"></select>
        </div>
        <div class="input_block">
            <label for="course">Курс сделки</label>
            <input type="number" name="course" required id="course" step="0.01" min="0" onkeyup="reCount()">
        </div>
        <div class="input_block">
            <label for="btc">Поступило</label>
            <input type="number" name="btc" required id="btc" step="0.00000001" min="0" onkeyup="reCount()">
        </div>
        <div class="input_block">
            <label for="commiss">Комиссия</label>
            <input type="number" name="commiss" id="commiss" step="0.01" min="0" value="0" onkeyup="reCount()">
        </div>
        <div class="input_block">
            <label for="bot_commiss">Комиссия бота</label>
            <input type="number" name="bot_commiss" id="bot_commiss" readonly step="0.01" min="0" value="0">
        </div>
        <div class="input_block middle">
            <label for="rub">Расход Р</label>
            <input type="number" name="rub" required id="rub" step="0.01" min="0" readonly>
        </div>
        <div class="info_block">
            Текущий средний курс: <span id="avg_course"></span><span id="avg_prognosis"></span>
        </div>
        <div class="centered">
            <button class="button submit_button" type="submit">Отправить</button>
        </div>
    </form>
    <div>
        <a href="menu.html">
            <button class="button exit_button">В меню</button>
        </a>
        <a href="buy_history.html">
            <button class="button exit_button">История операций</button>
        </a>
    </div>
</div>
</body>
</html>
<script>
    var avg, delayTimer;

    $(document).ready(function () {
        getAvgCourse(function (data) {
            document.getElementById('avg_course').innerHTML = data;
            avg = data;
        });

        fillSelect(document.getElementById('paym'), rubAccounts);
        fillSelect(document.getElementById('bitwallet'), btcAccounts);

        $("#post_form").on('submit', function (e) {
            e.preventDefault();
            $.ajax({
                url: apiServer + '/pay',
                beforeSend: function (req) {
                    req.setRequestHeader("Authorization", sessionStorage.getItem('token'));
                },
                type: 'post',
                crossDomain: true,
                data: $("#post_form").serialize(),
                success: function () {
                    document.getElementById('post_form').reset();
                    getAvgCourse(function (data) {
                        document.getElementById('avg_course').innerHTML = data;
                        avg = data;
                    });
                    document.getElementById('avg_prognosis').innerHTML = "";
                    alert("ok!");
                },
                error: function (err) {
                    alert(err);
                }
            });
        });


    });

    function reCount() {
        clearTimeout(delayTimer);
        delayTimer = setTimeout(function () {
            var btcValue = parseFloat($("#btc").val()),
                courseValue = parseFloat($("#course").val()),
                comissValue = parseFloat($("#commiss").val()),
                botcomissValue;
            if (isNaN(btcValue)) {
                btcValue = 0;
            }
            if (isNaN(courseValue)) {
                courseValue = 0;
            }
            if (isNaN(comissValue)) {
                comissValue = 0;
            }
            botcomissValue = btcValue * botComission;
            $("#bot_commiss").val(botcomissValue.toFixed(8));
            var rubResult = (courseValue * btcValue) - comissValue - (botcomissValue * btcValue);
            $("#rub").val(rubResult.toFixed(2));

            var prognosisLine = document.getElementById('avg_prognosis');
            var totalspent_new,
                totalbought_new;

            getTotalNormalSpent(function (data) {
                totalspent_new = data + rubResult;
                getTotalCryptoBought(function (data) {
                    totalbought_new = data + btcValue;
                    getAvgPrognose(totalspent_new, totalbought_new, function (data) {
                        var percentage = ((data / (avg / 100)) - 100).toFixed(2);
                        var percentage_string = "";
                        if (percentage > 0) {
                            percentage_string = ("+" + percentage);
                            prognosisLine.setAttribute('class', 'green');
                        } else {
                            percentage_string = (percentage);
                            prognosisLine.setAttribute('class', 'red');
                        }
                        prognosisLine.innerHTML = '; Прогнозируемое значение: ' + data + ' (' + percentage_string + '%)';
                    });
                });
            });
        }, 1000);
    }

    function getAvgPrognose(spent, bought, callback) {
        var result = (spent / bought).toFixed(2);
        callback(result);
    }
</script>
