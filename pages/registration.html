<!doctype html>
<script src="../js/privilege.js"></script>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../css/main.css">
    <title>Регистрация</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="../js/main.js"></script>
</head>
<body>
<div class="wrapper">
    <div class="header">
        Регистрация
    </div>
    <form method="post" id="post_form">
        <div class="input_block middle">
            <label for="login">Логин</label>
            <input type="text" name="login" id="login" required>
        </div>
        <div class="input_block middle">
            <label for="password">Пароль</label>
            <input type="password" name="password" id="password" required>
        </div>
        <div class="input_block middle">
            <label for="password-repeat">Повторите пароль</label>
            <input type="password" name="password-repeat" id="password-repeat" required>
        </div>
        <div class="input_block middle">
            <label for="privilege">Уровень доступа</label>
            <select name="privilege" id="privilege" required>
                <option value="user">Пользователь</option>
                <option value="admin">Администратор</option>
            </select>
        </div>
        <div id="error-msg" class="centered red"></div>
        <div class="centered">
            <button class="button submit_button" type="submit">Отправить</button>
        </div>
    </form>
    <div>
        <a href="menu.html">
            <button class="button exit_button">В меню</button>
        </a>
    </div>
</div>
</body>
</html>
<script>
    $(document).ready(function () {
        //Submit handler
        $("#post_form").on('submit', function (e) {
            e.preventDefault();
            var password = $("#password").val(),
                rePassword = $("#password-repeat").val();
            //rePassword check
            if (password !== rePassword) {
                document.getElementById('error-msg').innerHTML = 'Пароли не совпадают';
            } else {
                //Creating both user and agent
                $.ajax({
                    url: apiServer + '/createNewUser',
                    type: 'post',
                    headers: {'authorization': sessionStorage.getItem('token')},
                    data: $("#post_form").serialize(),
                    statusCode: {
                        409: function () {
                            document.getElementById('error-msg').innerHTML = 'Пользователь уже существует';
                        }
                    },
                    success: function (data) {
                        alert('Пользователь ' + $("#login").val() + ' был создан');
                        document.getElementById('error-msg').innerHTML = '';
                        document.getElementById('post_form').reset();
                    },
                    /*success: function (data) {
                        //if user created, duplicating his data to agent
                        $.ajax({
                            url: apiServer + '/anti_agent_add',
                            type: 'post',
                            headers: {'authorization': sessionStorage.getItem('token')},
                            data: "agentname=" + $("#login").val() + "&internal=true",
                            success: function (data1) {
                                alert('Пользователь ' + $("#login").val() + ' был создан');
                                console.log("agentname=" + $("#login").val() + "&internal=true");
                                document.getElementById('error-msg').innerHTML = '';
                                document.getElementById('post_form').reset();
                            },
                            error: function () {
                                document.getElementById('error-msg').innerHTML = 'Что-то пошло не так в ходе добавления контрагента';
                                document.getElementById('post_form').reset();
                            }
                        });
                    },*/
                    //unexpected error handler
                    error: function () {
                        document.getElementById('error-msg').innerHTML = 'Что-то пошло не так в ходе добавления нового пользователя';
                        document.getElementById('post_form').reset();
                    }
                });
            }
        });
    });
</script>
