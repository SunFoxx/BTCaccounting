<!doctype html>
<script src="../js/privilege.js"></script>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../css/vendor/bootstrap.min.css">
    <link rel="stylesheet" href="../css/main.css">
    <title>Регистрация</title>
    <script src="../js/vendor/jquery-3.2.1.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/vendor/sweetalert.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
</head>
<body>
<script>
    $(function(){
        $("#sidebar").load("templates/sidebar.html");
        $("#header").load("templates/header.html");
    });
</script>
<div id="sidebar"></div>
<div id="header" class="col-md-7"></div>
<div class="wrapper col-sm-7">
    <div class="header">
        Регистрация
    </div>
    <form method="post" id="post_form">
        <div class="input_block middle">
            <label for="login">Логин</label>
            <input type="text" name="login" id="login" placeholder="Login" required class="validate"
                   pattern="^[a-zA-Z]{1}[a-zA-Z-_]+$">
        </div>
        <div class="input_block middle">
            <label for="password">Пароль</label>
            <input type="password" name="password" id="password" placeholder="Password" required class="validate"
                   pattern="^[a-zA-Z]{1}[a-zA-Z0-9-_@#!$%&*()]+$">
        </div>
        <div class="input_block middle">
            <label for="password-repeat">Повторите пароль</label>
            <input type="password" name="password-repeat" id="password-repeat" placeholder="Password-again" required class="validate"
                   pattern="^[a-zA-Z]{1}[a-zA-Z0-9-_@#!$%&*()]+$">
        </div>
        <div class="input_block middle">
            <label for="privilege">Уровень доступа</label>
            <select name="privilege" id="privilege" required>
                <option value="user">Пользователь</option>
                <option value="admin">Администратор</option>
            </select>
        </div>
        <div id="error-msg" class="centered red"></div>
        <div class="centered">
            <button class="button submit_button" type="submit">Отправить</button>
        </div>
    </form>
    <div>
        <a href="menu.html">
            <button class="button exit_button">В меню</button>
        </a>
    </div>
</div>
</body>
</html>
<script>
    $(document).ready(function () {
        //Submit handler
        $("#post_form").on('submit', function (e) {
            e.preventDefault();
            var password = $("#password").val(),
                rePassword = $("#password-repeat").val();
            //rePassword check
            if (password !== rePassword) {
                document.getElementById('error-msg').innerHTML = 'Пароли не совпадают';
            } else {
                //Creating both user and agent
                $.ajax({
                    url: apiServer + '/createNewUser',
                    type: 'post',
                    headers: {'authorization': localStorage.getItem('token')},
                    data: $("#post_form").serialize(),
                    statusCode: {
                        409: function () {
                            document.getElementById('error-msg').innerHTML = 'Пользователь уже существует';
                        }
                    },
                    success: function (data) {
                        swal("Успех", 'Пользователь ' + $("#login").val() + ' был создан');
                        document.getElementById('error-msg').innerHTML = '';
                        document.getElementById('post_form').reset();
                    },
                    //unexpected error handler
                    error: function () {
                        document.getElementById('error-msg').innerHTML = 'Что-то пошло не так в ходе добавления нового пользователя';
                        document.getElementById('post_form').reset();
                    }
                });
            }
        });
    });
</script>
