<button id="sidebar_minimize"><i class="fa fa-th-list" aria-hidden="true"></i></button>
<div class="sidebar col-md-2" id="sidebar_block">
    <div class="sidebar_lists">
        <button class="accordion">Резервы <img id="reserves_loader" src="../img/loader.gif" width="22px"></button>
        <ul class="accordion_panel" id="reserves">
        </ul>
        <button class="accordion">Должники <img id="credit_loader" src="../img/loader.gif" width="22px"></button>
        <ul class="accordion_panel" id="credits">
        </ul>
        <button class="accordion">Долги <img id="debit_loader" src="../img/loader.gif" width="22px"></button>
        <ul class="accordion_panel" id="debits">
        </ul>
        <div class="hidden" id="mentor_invites">
            <button class="accordion" id="mentor_button">Приглашения</button>
            <ul class="accordion_panel" id="mentor">
            </ul>
        </div>
    </div>
</div>
<script>
    var creditsSidebar = [], debetsSidebar = [], reservesRemainders = [], mentorInvites = [], mentorsId = {}, currenciesSidebar = [];

    //accordion lists toggle
    var acc = document.getElementsByClassName('accordion');
    for (var i = 0; i < acc.length; i++) {
        acc[i].onclick = function () {
            this.classList.toggle("active");
            var panel = this.nextElementSibling;
            if (panel.style.maxHeight) {
                panel.style.maxHeight = null;
            } else {
                panel.style.maxHeight = panel.scrollHeight + "px";
            }
        }
    }

    //minimize button toggle
    document.getElementById('sidebar_minimize').onclick = function () {
        this.classList.toggle("active");
        var sidebar = document.getElementById('sidebar_block');
        if (sidebar.style.maxWidth) {
            sidebar.style.maxWidth = null;
            localStorage.setItem('sidebar_minimize', 'false')
        } else {
            sidebar.style.maxWidth = 0 + "px";
            localStorage.setItem('sidebar_minimize', 'true')
        }
    };
    if (localStorage.getItem('sidebar_minimize') === 'true') {
        $("#sidebar_minimize").click();
    }

    getCredits(function (data) {
        $.each(data.credit, function (key, value) {
            creditsSidebar.push(value);
        });
        $.each(data.debet, function (key, value) {
            debetsSidebar.push(value);
        });
        buildCreditTab();
        buildDebitTab();
    });

    var q1 = getRemainders(function (data) {
        $.each(data, function (key, value) {
            reservesRemainders.push(value);
        });
    });

    var q2 = getCurrencyList(function (data) {
        currenciesSidebar = data;
    });

    $.when(q1, q2).done(function () {
        buildRemainderTab();
    });

    getMentorInvites(function (data) {
        $.each(data, function (key, value) {
            mentorInvites.push(value);
        });
        buildMentorInvitesTab();
    });

    function buildMentorInvitesTab() {
        if (mentorInvites.length !== 0) {
            $("#mentor").html('');
            var operational_data = "", rowCount = 0;
            $.each(mentorInvites, function (key, value) {
                rowCount++;
                mentorsId[rowCount] = value;
                operational_data += '<li id="listedInvite' + rowCount + '">';
                operational_data += value.mentor + ' приглашает вас стать его учеником, ' + value.percent + "% от финреза в " + value.currency;
                operational_data += ' <a class="sidebar_icon green" onclick="replyToMentorInvite(' + rowCount + ', true' + ')"><i class="fa fa-check" aria-hidden="true"></i></a>';
                operational_data += ' <a class="sidebar_icon red" onclick="replyToMentorInvite(' + rowCount + ', false' + ')"><i class="fa fa-ban" aria-hidden="true"></i></a>';
                operational_data += '</li>';
            });
            $("#mentor_button").html("Приглашения (" + mentorInvites.length + ")");
            $("#mentor").append(operational_data);
            $("#mentor_invites").show();
        }
    }

    function buildRemainderTab() {
        if (reservesRemainders.length !== 0) {
            $("#reserves").html('');
            var operational_data = "", numberLimiter = 2;
            $.each(reservesRemainders, function (key, value) {
                operational_data += '<li>';
                numberLimiter = (currenciesSidebar.find(function (a) {
                    return a.currency === value.currency
                }).isCrypto === 'true') ? 8 : 2;
                operational_data += "<span class='align_left col-md-5'>" + value.title + ':</span><span class="align_right col-md-7">' +
                    value.remainder.toFixed(numberLimiter) + ' ' + value.currency + "</span>";
                operational_data += '</li>';
            });
            $("#reserves").append(operational_data);
        } else {
            $("#reserves").html('<li>Нет резервов</li>');
        }
        $("#reserves_loader").hide();
    }

    function buildCreditTab() {
        if (creditsSidebar.length !== 0) {
            $("#credits").html('');
            var operational_data = "", creditList = {}, currentUser = "", creditSum = 0;
            creditsSidebar.sort(function (a1, a2) {
                return a1.debet.localeCompare(a2.debet);
            });
            $.each(creditsSidebar, function (key, value) {
                if (value.debet === currentUser && currentUser !== "") {
                    creditSum += value.debts;
                } else {
                    creditSum = value.debts;
                }
                currentUser = value.debet;
                creditList[currentUser] = creditSum;
            });
            $.each(creditList, function (key, value) {
                operational_data += '<li>';
                operational_data += '<span class=\'align_left col-md-5\'>' + key + '</span><span class=\'align_right col-md-7\'> ' + value.toFixed(2) + '</span>';
                operational_data += '</li>';
            });
            $("#credits").append(operational_data);
        } else {
            $("#credits").html('<li>Нет должников</li>');
        }
        $("#credit_loader").hide();
    }

    function buildDebitTab() {
        if (debetsSidebar.length !== 0) {
            $("#debits").html('');
            var operational_data = "", debitList = {}, currentUser = "", debitSum = 0;
            debetsSidebar.sort(function (a1, a2) {
                return a1.credit.localeCompare(a2.credit);
            });
            $.each(debetsSidebar, function (key, value) {
                if (value.credit === currentUser && currentUser !== "") {
                    debitSum += value.debts;
                } else {
                    debitSum = value.debts;
                }
                currentUser = value.credit;
                debitList[currentUser] = debitSum;
            });
            $.each(debitList, function (key, value) {
                operational_data += '<li>';
                operational_data += '<span class=\'align_left col-md-5\'>' + key + '</span><span class=\'align_right col-md-7\'> ' + value.toFixed(2) + "</span>";
                operational_data += '</li>';
            });
            $("#debits").append(operational_data);
        } else {
            $("#debits").html('<li>Нет долгов</li>');
        }
        $("#debit_loader").hide();
    }

    function replyToMentorInvite(id, reply) {
        var replyText = (reply === true) ? "стать" : "отказаться быть";
        swal({
            title: "Подтверждение",
            text: "Вы уверены, что хотите " + replyText + " учеником " + mentorsId[id].mentor + "?",
            buttons: true,
            icon: "warning"
        }).then(function (isPressed) {
            if (isPressed) {
                $.ajax({
                    url: apiServer + '/consent',
                    type: 'post',
                    headers: {'authorization': token},
                    data: "&status=" + reply,
                    success: function (data) {
                        swal("Успех", "Операция проведена успешно", "success");
                        delete mentorInvites[id];
                        var buttonString = (Object.keys(mentorInvites).length > 0) ? "(" + Object.keys(mentorInvites).length + ")" : "";
                        $("#mentor_button").html("Приглашения " + buttonString);
                        $("#listedInvite" + id).hide(400);
                    },
                    error: function (err) {
                        swal("Ошибка " + err.status, "Что-то пошло не так", "error");
                    }
                });
            }
        });
    }
</script>
